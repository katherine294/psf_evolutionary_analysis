---
title: "Pangenomic analysis: orthologue clustering, QC, presence/absence analysis, enrichment"
output: html_notebook
---


Assemble, annotate and run panaroo
```{bash}
sbatch scripts/09.Assembly.sh
sbatch scripts/10.bakta_annotation.sh
sbatch scripts/11.Panaroo.sh
```

Create core gene tree with IQTREE
```{bash}
#!/bin/bash
#SBATCH --job-name=iqtree2
#SBATCH --time=24:00:00
#SBATCH --ntasks=4
#SBATCH --nodes=1
#SBATCH --output=/rds/homes/k/kgh742/psf_wgs_project/slurm_logs/iqtree2_%A.out
#SBATCH --error=/rds/homes/k/kgh742/psf_wgs_project/slurm_logs/iqtree2_%A.err

set -euo pipefail

module purge
module load bear-apps/2022b
module load IQ-TREE/2.2.2.6-gompi-2022b

# Define paths
PROJECT_BASE="/rds/homes/k/kgh742/psf_wgs_project"
INPATH="$PROJECT_BASE/Panaroo_output"

cd $INPATH

iqtree2 -s core_gene_alignment_filtered.aln \
-B 1000 -alrt 1000 -T 30 \
-pre ncbi_reduced_99core

# -----------------------------------------------------------------------------------------#
#                           Collapse clades < 70 support                                   # 
# -----------------------------------------------------------------------------------------#

# Reload dependancies as they use a different bear version
module purge
module load bear-apps/2022b
module load Miniforge3/24.1.2-0

# Initialise conda/mamba
eval "$(${EBROOTMINIFORGE3}/bin/conda shell.bash hook)"
source "${EBROOTMINIFORGE3}/etc/profile.d/mamba.sh"

# Define paths
CONDA_ENV_PATH="/rds/homes/k/kgh742/psf_wgs_project/conda/${USER}_gotree"
export CONDA_PKGS_DIRS="/scratch/${USER}/conda_pkgs"

# Create environment (only needs to be done once)
if [ ! -d "${CONDA_ENV_PATH}" ]; then
    echo "Creating gotree conda environment..."
    mamba create --yes --prefix "${CONDA_ENV_PATH}" python=3.10 gotree
fi

# Activate environment
mamba activate "${CONDA_ENV_PATH}"

# Input and output tree files from IQ-TREE2
INPUT_TREE="ncbi_reduced_99core.tree"
OUTPUT_TREE="ncbi_reduced_99core_70BS_collapsed.tree"

# Collapse nodes below 70 bootstrap support
echo "Starting gotree clade collapse..."

gotree collapse support \
  --support 70 \
  --input "$INPUT_TREE" \
  --output "$OUTPUT_TREE"

echo "Collapsed tree saved as: $OUTPUT_TREE"
```

Gene presence/absence image using Panstripe
```{r}
# Load packages
library(panstripe)
library(ape)
library(patchwork)

# Set random seed for reproducibility
set.seed(1234)

# Visualisation on interactive cluster
options(bitmapType='cairo')

### Read in file paths 
phylo.file.name <- "/rds/homes/k/kgh742/psf_wgs_project/Panaroo_output/ncbi_reduced_99core_70_mpr.tree"
rtab.file.name <- "/rds/homes/k/kgh742/psf_wgs_project/Panaroo_output/gene_presence_absence.Rtab"

# Load files
pa <- read_rtab(rtab.file.name)
tree <- read.tree(phylo.file.name)

# Run panstripe - optional analyses - info https://github.com/gtonkinhill/panstripe
fit <- panstripe(pa, tree)
fit$summary
plot_pangenome_params(fit)
plot_pangenome_cumulative(fit)
plot_residuals(fit)
plot_tsne(pa)

# Define output file and resolution - save as high res PNG
png("/rds/homes/k/kgh742/psf_wgs_project/Panaroo_output/presence_absence_variable.png", width = 400, height = 400, units='mm', res = 300)

# Plot your tree
variable_genes <- colnames(pa)[apply(pa, 2, sd) > 0]
plot_tree_pa(tree = tree, pa = pa, genes = variable_genes,
             label_tips = FALSE, align = FALSE, label_genes = FALSE, cols = "black")

# Close the device to write file
dev.off()
```

Jaccard PCoA and plot
```{r}
library(vegan)
library(RColorBrewer)
library(tidyverse)

# --- Load Panaroo presence/absence file ---
pa <- read.csv("/rds/homes/k/kgh742/psf_wgs_project/Panaroo_output/gene_presence_absence.csv", 
               header = TRUE, stringsAsFactors = FALSE)

meta <- read_csv("/rds/homes/k/kgh742/psf_wgs_project/metadata_clade.csv")
rownames(meta) <- meta$Strain

# --- Extract presence/absence matrix (adjust start column if needed) ---
mat <- pa[, 4:ncol(pa)]
rownames(mat) <- pa$Gene

# --- Convert to binary (0/1) ---
mat_bin <- ifelse(mat == "", 0, 1)
mat_bin <- as.matrix(mat_bin)

# --- Filter invariant genes and strains ---
mat_bin_filtered <- mat_bin[, apply(mat_bin, 2, function(x) length(unique(x)) > 1)]
mat_bin_filtered <- mat_bin_filtered[apply(mat_bin_filtered, 1, function(x) length(unique(x)) > 1), ]
mat_bin_filtered <- mat_bin_filtered[, apply(mat_bin_filtered, 2, var) > 0]

# --- Count variable genes ---
num_variable_genes <- nrow(mat_bin_filtered)
cat("Number of variable genes:", num_variable_genes, "\n")

# --- Match metadata order to isolates in matrix ---
meta <- meta[colnames(mat_bin_filtered), ]

# --- Distance-based PCoA (Jaccard) ---
dist_jac <- vegdist(t(mat_bin_filtered), method = "jaccard", binary = TRUE)
pcoa_jac <- cmdscale(dist_jac, k = 2, eig = TRUE)

# --- Define factor in desired order ---
legend_order <- c("1A","2A","3A","4A","4B","5A","6A","6B",
                  "7A","7B","8A","8B","8C","9A","10A","12")
meta$clade_subclade <- factor(meta$clade_subclade, levels = legend_order)

# --- Generate color palette ---
n_groups <- length(levels(meta$clade_subclade))
palette <- brewer.pal(min(n_groups, 12), "Paired")
if (n_groups > 12) {
  palette <- colorRampPalette(brewer.pal(12, "Paired"))(n_groups)
}

# --- Map clades to colors ---
color_map <- setNames(palette, levels(meta$clade_subclade))
cols <- color_map[as.character(meta$clade_subclade)]
cols_trans <- adjustcolor(cols, alpha.f = 0.8)

# --- Plot PCoA ---
par(mar = c(5, 4, 4, 8))  # extra margin for legend
plot(pcoa_jac$points[,1], pcoa_jac$points[,2],
     pch = 19, col = cols_trans,
     xlab = "PCoA1", ylab = "PCoA2",
     main = "PCoA (Jaccard)")

# --- Add legend outside plot ---
par(xpd = TRUE)
legend("topright", inset = c(-0.25, 0),
       legend = legend_order,
       col = palette,
       pch = 19,
       ncol = 1,
       cex = 0.8)
par(xpd = FALSE)
```

Extract Distance-based RDA
```{r}
library(vegan)
# --- Distance-based RDA (like PCoA but with loadings) ---
cap <- capscale(t(mat_bin_filtered) ~ 1, distance = "jaccard")

# Extract "species" scores (i.e., gene loadings)
loadings <- scores(cap, display = "species")

# --- Top/bottom 20 for PC1 ---
top_pos_pc1 <- head(order(loadings[,1], decreasing = TRUE), 20)
top_neg_pc1 <- head(order(loadings[,1], decreasing = FALSE), 20)
genes_pc1 <- data.frame(
  Gene = rownames(loadings)[c(top_pos_pc1, top_neg_pc1)],
  Axis = "PC1",
  Loading = loadings[c(top_pos_pc1, top_neg_pc1), 1]
)

# --- Top/bottom 20 for PC2 ---
top_pos_pc2 <- head(order(loadings[,2], decreasing = TRUE), 20)
top_neg_pc2 <- head(order(loadings[,2], decreasing = FALSE), 20)
genes_pc2 <- data.frame(
  Gene = rownames(loadings)[c(top_pos_pc2, top_neg_pc2)],
  Axis = "PC2",
  Loading = loadings[c(top_pos_pc2, top_neg_pc2), 2]
)

# --- Combine into single dataframe ---
gene_loadings <- rbind(genes_pc1, genes_pc2) %>%
  as.data.frame() 

write_csv(gene_loadings, "/rds/homes/k/kgh742/psf_wgs_project/Panaroo_output/top20_gene_loadings.csv")
```


PULL OUT WHICH STRAINS HAVE GENES OF INTEREST IN 
```{R}
# --- Genes of interest (your full list) ---
genes_interest <- c(
  "group_3841","group_3840","group_3839","group_3838","group_3837",
  "group_3836","group_3835","traD","group_3827","group_3826",
  "group_3791","group_3787","group_3782","group_3774","group_3765",
  "group_3738","group_3736","group_3735","group_3734","group_3686",
  "group_3250","traJ","group_3776","group_4142","group_3498",
  "group_3561","group_2888","group_1857","korA~~~trfB","group_1999",
  "group_2904","group_3869","group_3355","group_1772","group_498",
  "group_3798","group_3132","group_2816","group_3225","group_555",
  "group_2486","group_2190","group_3563","group_3812","group_3721",
  "group_3718","group_3612","group_3514","group_3162","group_2945",
  "group_2886","group_2792","abiV","group_2018","group_1885",
  "group_4060","group_4059","group_3530","group_3930","group_2395",
  "group_3783","group_3606","group_3920","group_3919","group_3918",
  "group_3917","group_3916","group_3915","group_3914","group_3913",
  "group_3912","excA","group_3806","group_3923","group_3394","ddpX",
  "group_1170","ddpC","group_909","group_816"
)

# --- Subset the presence/absence matrix ---
subset_mat <- mat_bin_filtered[genes_interest, , drop = FALSE]

# --- Convert to comma-separated list of strains ---
df_gene_strains <- data.frame(
  Gene = rownames(subset_mat),
  Strains = apply(subset_mat, 1, function(x) {
    paste(colnames(subset_mat)[x == 1], collapse = ",")
  }),
  stringsAsFactors = FALSE
)

# View result
df_gene_strains

write_csv(df_gene_strains, "/rds/homes/k/kgh742/psf_wgs_project/Panaroo_output/jaccard_pcoa_loading_strains.csv")

```
