---
title: "Multi-scale diversity"
output: html_notebook
note: This script calculates SNP distance between P. savastanoi pv. fraxini genomes at a site-, tree-, and tissue-level, using the VCF file output from snippy.
---

Load packages
```{r}
library(readr)
library(vcfR)
library(ape)
library(dplyr)
library(ggplot2)
library(tidyr)
library(tidyverse)
```

Read in vcf file
```{r}
vcf <- read.vcfR("~/W163a3b1_core_genome_masked.vcf")

# Convert vcf to binary data matrix 
geno <- extract.gt(vcf, element = "GT", as.numeric = TRUE) 
geno[is.na(geno)] <- 0  # Replace missing genotypes with 0

# Compute pairwsie SNP distance  - Hamming distance (counting SNP differences) to create a distance matrix.
snp_dist <- dist(t(geno), method = "manhattan")  # Manhattan distance counts differences

# Convert distance object into a matrix:
snp_dist_matrix <- as.matrix(snp_dist)
rownames(snp_dist_matrix) <- colnames(geno)
colnames(snp_dist_matrix) <- colnames(geno)

# Save matrix to file
write.table(snp_dist_matrix, "snp_dist_binary_masked.txt", sep="\t", quote=FALSE, col.names=NA)
```

CREATING FIGURE FOR NESTED SPATIAL SCALE GENETIC DIVERSITY CHANGE
```{r}
# Load metadata (assume it has isolate names and site information)
metadata <- read.csv("~/strains_r_input.csv")

# Keep only strains that exist in the distance matrix
meta_subset <- metadata[metadata$Strain %in% rownames(snp_dist_matrix), ]

# ---------------------------------------------
#    Compute mean intra-site SNP distances    #
# ---------------------------------------------
calculate_intra_site_diversity <- function(Site, snp_dist_matrix, metadata) {
  isolates_in_site <- metadata$Strain[metadata$Site == Site]
  
  # Keep only strains that exist in the distance matrix
  isolates_in_site <- isolates_in_site[isolates_in_site %in% rownames(snp_dist_matrix)]
  
  if (length(isolates_in_site) < 2) {
    return(NA)  # Return NA if site has fewer than 2 isolates
  }
  
  sub_matrix <- snp_dist_matrix[isolates_in_site, isolates_in_site, drop=FALSE]
  site_distance <- mean(sub_matrix[upper.tri(sub_matrix)])  # Avoid self-comparisons
  
  return(site_distance)
}

# Apply to all sites
intra_site_diversity <- metadata %>%
  distinct(Site) %>%
  rowwise() %>%
  mutate(Intra_site_distance = calculate_intra_site_diversity(Site, snp_dist_matrix, metadata))

print(intra_site_diversity)

# ---------------------------------------------
#    Compute mean intra-tree SNP distances    #
# ---------------------------------------------

calculate_intra_tree_diversity <- function(site_tree, snp_dist_matrix, metadata) {
  isolates <- metadata$Strain[metadata$site_tree == site_tree]
  
  # Keep only strains that exist in the SNP distance matrix
  isolates <- isolates[isolates %in% rownames(snp_dist_matrix)]
  
  if (length(isolates) < 2) {
    return(NA)  # Not enough isolates to calculate distance
  }
  
  sub_matrix <- snp_dist_matrix[isolates, isolates, drop=FALSE]
  tree_distance <- mean(sub_matrix[upper.tri(sub_matrix)])  # Avoid self-self comparisons
  
  return(tree_distance)
}

# Create data frame of unique Site + Tree combinations
intra_tree_diversity <- metadata %>%
  distinct(Site, Tree, site_tree) %>%
  rowwise() %>%
  mutate(Intra_tree_distance = calculate_intra_tree_diversity(site_tree, snp_dist_matrix, metadata)) %>%
  ungroup() %>%
  select(Site, Tree, Intra_tree_distance)


# ---------------------------------------------
#    Compute mean intra-tissue SNP distances    #
# ---------------------------------------------

# Create new tissue grouping column
metadata <- metadata %>%
  mutate(site_tree_tissue = paste(Site, Tree, Tissue, sep = "_"))

# Define the function to compute mean intra-group SNP distance
calculate_intra_group_diversity <- function(group_id, snp_dist_matrix, metadata) {
  isolates <- metadata$Strain[metadata$site_tree_tissue == group_id]
  
  # Keep only strains that exist in the SNP distance matrix
  isolates <- isolates[isolates %in% rownames(snp_dist_matrix)]
  
  if (length(isolates) < 2) {
    return(NA)  # Return 0 instead of NA for singletons
  }
  
  sub_matrix <- snp_dist_matrix[isolates, isolates, drop = FALSE]
  tissue_distance <- mean(sub_matrix[upper.tri(sub_matrix)])
  
  return(tissue_distance)
}

# Apply to each site_tree_tissue group
intra_tissue_diversity <- metadata %>%
  distinct(Site, Tree, Tissue, site_tree_tissue) %>%
  rowwise() %>%
  mutate(Intra_tissue_distance = calculate_intra_group_diversity(site_tree_tissue, snp_dist_matrix, metadata)) %>%
  ungroup() %>%
  select(Site, Tree, Tissue, Intra_tissue_distance)

#### Combine all distance measures for site, tree and tissue in excel ####

# Join tissue with tree diversity
final_SNP_distance <- intra_tissue_diversity %>%
  left_join(intra_tree_diversity, by = c("Site", "Tree")) %>%
  left_join(intra_site_diversity, by = "Site")

# Ensure Tree is a factor ordered A1–A12
final_SNP_distance$Tree <- factor(final_SNP_distance$Tree, levels = paste0("A", 1:12))
```

Transform dataframe and plot 
```{r}
# Reshape to long format
long_df <- final_SNP_distance %>%
  pivot_longer(
    cols = c(Intra_tissue_distance, Intra_tree_distance, Intra_site_distance),
    names_to = "Level",
    values_to = "SNP_Diversity"
  ) %>%
  mutate(Level = case_when(
    Level == "Intra_tissue_distance" ~ "Tissue",
    Level == "Intra_tree_distance" ~ "Tree",
    Level == "Intra_site_distance" ~ "Site"
  ))

# Ensure Level is ordered
long_df$Level <- factor(long_df$Level, levels = c("Site", "Tree", "Tissue"))

# Unique line ID per tree-tissue
long_df <- long_df %>%
  mutate(Line_ID = paste(Tree, Tissue, sep = "_"))

long_df <- long_df %>%
  filter(!Site %in% c("Matlock", "Marden park", "UK")) %>%
  filter(!is.na(Tree))


# Manual tree colour palette
tree_colours <- c("#0055AAFF", "#00C19BFF", "#C40003FF", "#EAC862FF",
                  "#7FD2FFFF", "#FF9D1EFF", "#B2DF8AFF", "#FFACAAFF",
                  "#894FC6FF", "#007ED3FF")

# Plot with all sites faceted
ggplot(long_df, aes(x = Level, y = SNP_Diversity, group = Line_ID, color = Tree)) +
  geom_line(linewidth = 1) +
  geom_point() +
  facet_wrap(~ Site, scales = "free_y") +  # Add facets for each site
  theme_bw() +
  labs(x = NULL, y = "SNP Diversity", title = "Divergence of SNP Diversity from Site → Tree → Tissue") +
  theme(legend.position = "right") +
  scale_color_manual(values = tree_colours)

```
