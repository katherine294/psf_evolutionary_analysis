---
title: "Multi-scale diversity"
output: html_notebook
note: This script calculates SNP distance between P. savastanoi pv. fraxini genomes at a site-, tree-, and tissue-level, using the VCF file output from snippy.
---

Load packages
```{r}
library(readr)
library(vcfR)
library(ape)
library(dplyr)
library(ggplot2)
library(tidyr)
library(tidyverse)
```

Read in vcf file
```{r}
vcf <- read.vcfR("~/Masked_core.vcf")

# Convert vcf to binary data matrix 
geno <- extract.gt(vcf, element = "GT", as.numeric = TRUE) 
geno[is.na(geno)] <- 0  # Replace missing genotypes with 0

# Compute pairwsie SNP distance  - Hamming distance (counting SNP differences) to create a distance matrix.
snp_dist <- dist(t(geno), method = "manhattan")  # Manhattan distance counts differences

# Convert distance object into a matrix:
snp_dist_matrix <- as.matrix(snp_dist)
rownames(snp_dist_matrix) <- colnames(geno)
colnames(snp_dist_matrix) <- colnames(geno)

# Save matrix to file
write.table(snp_dist_matrix, "snp_dist_binary_masked.txt", sep="\t", quote=FALSE, col.names=NA)
```

CREATING FIGURE FOR NESTED SPATIAL SCALE GENETIC DIVERSITY CHANGE
```{r}
# Load metadata (assume it has isolate names and site information)
metadata <- read.csv("~/strains_r_input.csv")

# Keep only strains that exist in the distance matrix
meta_subset <- metadata[metadata$Strain %in% rownames(snp_dist_matrix), ]

##### Mean intra-site SNP distances #####

calculate_intra_site_diversity <- function(Site, snp_dist_matrix, metadata) {
  isolates_in_site <- metadata$Strain[metadata$Site == Site]
  
  # Keep only strains that exist in the distance matrix
  isolates_in_site <- isolates_in_site[isolates_in_site %in% rownames(snp_dist_matrix)]
  
  if (length(isolates_in_site) < 2) {
    return(NA)  # Return NA if site has fewer than 2 isolates
  }
  
  sub_matrix <- snp_dist_matrix[isolates_in_site, isolates_in_site, drop=FALSE]
  mean_distance <- mean(sub_matrix[upper.tri(sub_matrix)])  # Avoid self-comparisons
  
  return(mean_distance)
}

# Apply to all sites
intra_site_diversity <- metadata %>%
  distinct(Site) %>%
  rowwise() %>%
  mutate(mean_distance = calculate_intra_site_diversity(Site, snp_dist_matrix, metadata))

print(intra_site_diversity)

write_csv(intra_site_diversity, "~/intra_site_diversity.txt")

##### Mean intra-tree SNP distances #####

calculate_intra_tree_diversity <- function(site_tree, snp_dist_matrix, metadata) {
  isolates <- metadata$Strain[metadata$site_tree == site_tree]
  
  # Keep only strains that exist in the SNP distance matrix
  isolates <- isolates[isolates %in% rownames(snp_dist_matrix)]
  
  if (length(isolates) < 1) {
    return(NA)  # Not enough isolates to calculate distance
  }
  
  sub_matrix <- snp_dist_matrix[isolates, isolates, drop=FALSE]
  mean_distance <- mean(sub_matrix[upper.tri(sub_matrix)])  # Avoid self-self comparisons
  
  return(mean_distance)
}

# Create data frame of unique Site + Tree combinations
intra_tree_diversity <- metadata %>%
  distinct(Site, Tree, site_tree) %>%
  rowwise() %>%
  mutate(Intra_tree_diversity = calculate_intra_tree_diversity(site_tree, snp_dist_matrix, metadata)) %>%
  ungroup()

# View the result
print(intra_tree_diversity)
write_csv(intra_tree_diversity, "~/intra-tree_diversity.csv")


######## Intra-tissue SNP distance #########

# Step 1: Create new grouping column
metadata <- metadata %>%
  mutate(site_tree_tissue = paste(Site, Tree, Tissue, sep = "_"))

# Step 2: Define the function to compute mean intra-group SNP distance
calculate_intra_group_diversity <- function(group_id, snp_dist_matrix, metadata) {
  isolates <- metadata$Strain[metadata$site_tree_tissue == group_id]
  
  # Keep only strains that exist in the SNP distance matrix
  isolates <- isolates[isolates %in% rownames(snp_dist_matrix)]
  
  if (length(isolates) < 2) {
    return(NA)  # Return 0 instead of NA for singletons
  }
  
  sub_matrix <- snp_dist_matrix[isolates, isolates, drop = FALSE]
  mean_distance <- mean(sub_matrix[upper.tri(sub_matrix)])
  
  return(mean_distance)
}

# Step 3: Apply to each site_tree_tissue group
intra_tissue_diversity <- metadata %>%
  distinct(Site, Tree, Tissue, site_tree_tissue) %>%
  rowwise() %>%
  mutate(Intra_group_diversity = calculate_intra_group_diversity(site_tree_tissue, snp_dist_matrix, metadata)) %>%
  ungroup()

# Step 4: View results
print(intra_group_diversity)
write_csv(intra_tissue_diversity, "~/intra-tissue_diversity.csv")

#### Combine all distance measures for site, tree and tissue in excel ####

df <- read_csv("~/OneDrive - University of Birmingham/Genotype-phenotype paper/Data for figures/Section 3 - Genomic analysis/Phylogeny/diversity_levels.csv")

# Structure should be as below:
str(df) 
#spc_tbl_ [61 × 6] (S3: spec_tbl_df/tbl_df/tbl/data.frame)
# $ Site                  : chr [1:61] "Cressbrook Dale" "Cressbrook Dale" "Cressbrook Dale" "Cressbrook Dale" ...
# $ Tree                  : chr [1:61] "A1" "A1" "A1" "A1" ...
# $ Tissue                : chr [1:61] "B2" "B2" "B3" "S1" ...
# $ Intra tissue diversity: num [1:61] 1 NA NA NA 4 NA 5 NA NA NA ...
# $ Intra tree diversity  : num [1:61] 14.5 14.5 14.5 14.5 14.5 ...
# $ Intra site diversity  : num [1:61] 23.1 23.1 23.1 23.1 23.1 ...

# Ensure Tree is a factor ordered A1–A12
df$Tree <- factor(df$Tree, levels = paste0("A", 1:12))

# Reshape to long format
long_df <- df %>%
  pivot_longer(
    cols = c(`Intra tissue diversity`, `Intra tree diversity`, `Intra site diversity`),
    names_to = "Level",
    values_to = "SNP_Diversity"
  ) %>%
  mutate(Level = case_when(
    Level == "Intra tissue diversity" ~ "Tissue",
    Level == "Intra tree diversity" ~ "Tree",
    Level == "Intra site diversity" ~ "Site"
  ))

# Ensure Level is ordered
long_df$Level <- factor(long_df$Level, levels = c("Site", "Tree", "Tissue"))

# Unique line ID per tree-tissue
long_df <- long_df %>%
  mutate(Line_ID = paste(Tree, Tissue, sep = "_"))

long_df <- long_df %>% filter(!Site == "Matlock" & !Site == "Marden park")

# Count number of strains per tissue
tissue_counts <- meta_subset %>%
  group_by(Site, Tree, Tissue) %>%
  summarise(Strain_count = n(), .groups = "drop")

long_df_tissue <- long_df %>% 
  filter(Level == "Tissue") %>%
  left_join(tissue_counts, by = c("Site", "Tree", "Tissue"))


tree_counts <- meta_subset %>%
  group_by(Site, Tree) %>%
  summarise(Strain_count = n(), .groups = "drop")

long_df_tree <- long_df %>% 
  filter(Level == "Tree") %>%
  left_join(tree_counts, by = c("Site", "Tree"))

site_counts <- meta_subset %>%
  group_by(Site) %>%
  summarise(Strain_count = n(), .groups = "drop")

long_df_site <- long_df %>% 
  filter(Level == "Site") %>%
  left_join(site_counts, by = "Site")

combined <- bind_rows(long_df_tissue, long_df_tree, long_df_site) 

combined <- combined %>%
  mutate(Normalised_Diversity = SNP_Diversity / Strain_count)

# Manual tree colour palette
tree_colours <- c("#0055AAFF", "#00C19BFF", "#C40003FF", "#EAC862FF",
                  "#7FD2FFFF", "#FF9D1EFF", "#B2DF8AFF", "#FFACAAFF",
                  "#894FC6FF", "#007ED3FF")

# Plot with all sites faceted
ggplot(combined, aes(x = Level, y = Normalised_Diversity, group = Line_ID, color = Tree)) +
  geom_line(linewidth = 1) +
  geom_point() +
  facet_wrap(~ Site, scales = "free_y") +  # Add facets for each site
  theme_bw() +
  labs(x = NULL, y = "SNP Diversity", title = "Divergence of SNP Diversity from Site → Tree → Tissue") +
  theme(legend.position = "right") +
  scale_color_manual(values = tree_colours)


```
